#!/bin/bash
set -x

source /opt/mesosphere/environment


pushd /pkg/src/networking_api
./rebar3 update
make rel
popd

cp -r /pkg/src/networking_api/_build/default/rel/networking_api ${PKG_PATH}

service=${PKG_PATH}/dcos.target.wants_master/dcos-networking_api.service
mkdir -p $(dirname $service)
cat <<EOF > $service
[Unit]
Description=DC/OS Network Metrics: exposes network metrics
BindsTo=dcos-epmd.service

[Service]
PermissionsStartOnly=True
User=dcos_networking_api
Restart=always
StartLimitInterval=0
RestartSec=5
LimitNOFILE=16384
WorkingDirectory=${PKG_PATH}/networking_api
EnvironmentFile=/opt/mesosphere/etc/networking_api-erl.env
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/networking_api.env
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-networking_api
ExecStart=${PKG_PATH}/networking_api/bin/networking-api-env foreground
Environment=HOME=/opt/mesosphere
EOF
