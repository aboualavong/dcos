#!/bin/bash

mkdir -p "$PKG_PATH/lib/"
mkdir -p "$PKG_PATH/usr/"

export PKG_PATH
cosmos_wrapper="$PKG_PATH/bin/cosmos.sh"
mkdir -p "$(dirname "$cosmos_wrapper")"
envsubst '$PKG_PATH' < /pkg/extra/cosmos.sh > "$cosmos_wrapper"
chmod +x "$cosmos_wrapper"

cp -rp /pkg/src/cosmos/cosmos-*-one-jar.jar "${PKG_PATH}/usr/cosmos.jar"
sudo chmod -R o+r "${PKG_PATH}/usr"

cosmos_service="${PKG_PATH}/dcos.target.wants_master/dcos-cosmos.service"
mkdir -p $(dirname "$cosmos_service")

cat <<EOF > "$cosmos_service"
[Unit]
Description=Package Service: DCOS Packaging API
After=dcos-mesos-master.service
After=dcos-gen-resolvconf.service

[Service]
Restart=always
StartLimitInterval=0
RestartSec=15
User=dcos_cosmos
PermissionsStartOnly=True
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=-/var/lib/dcos/environment.proxy
EnvironmentFile=/opt/mesosphere/etc/cosmos
ExecStartPre=/bin/ping -c1 ready.spartan
## CoreOS
ExecStartPre=-/usr/bin/mkdir -p /var/lib/cosmos
## Ubuntu
ExecStartPre=-/bin/mkdir -p /var/lib/cosmos
EOF
if [ "$PKG_VARIANT" = "ee" ]; then
  cat <<EOF >> "$cosmos_service"
EnvironmentFile=-/run/dcos/etc/cosmos.env
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-cosmos
ExecStartPre=/usr/bin/test -f /run/dcos/pki/tls/certs/cosmos.crt -a -f /run/dcos/pki/tls/private/cosmos.key
ExecStart=/opt/mesosphere/bin/cosmos.sh
EOF
else
  cat <<EOF >> "$cosmos_service"
ExecStart=/opt/mesosphere/bin/java -Xmx2G -classpath ${PKG_PATH}/usr/cosmos.jar com.simontuffs.onejar.Boot
EOF
fi
