#!/bin/bash
export GOPATH=$GOPATH:/pkg
mkdir -p /pkg/src/github.com/dcos
# Create the GOPATH for the go tool to work properly
mv /pkg/src/3dt /pkg/src/github.com/dcos/
cd /pkg/src/github.com/dcos/3dt/

# Add enterprise patch. TODO(mnaboka): use variant variable here.
cp -r /pkg/src/3dt-enterprise/* ./
go get
go install
# Copy the build from the bin to the correct place
cp -r /pkg/bin/ "$PKG_PATH"

# Copy the snapshot config file
cp -v /pkg/src/github.com/dcos/3dt/endpoints_config.json $PKG_PATH/

master_service=${PKG_PATH}/dcos.target.wants_master/dcos-3dt.service
slave_service=${PKG_PATH}/dcos.target.wants_slave/dcos-3dt.service
slave_public_service=${PKG_PATH}/dcos.target.wants_slave_public/dcos-3dt.service

master_socket_service=${PKG_PATH}/dcos.target.wants_master/dcos-3dt.socket
slave_socket_service=${PKG_PATH}/dcos.target.wants_slave/dcos-3dt.socket
slave_public_socket_service=${PKG_PATH}/dcos.target.wants_slave_public/dcos-3dt.socket
mkdir -p $(dirname $master_service)
mkdir -p $(dirname $slave_service)
mkdir -p $(dirname $slave_public_service)
cat <<EOF | tee $master_socket_service $slave_socket_service $slave_public_socket_service
[Unit]
Description=Diagnostics socket: DCOS Distributed Diagnostics Tool Master API and Aggregation Socket

[Socket]
ListenStream=/run/dcos/3dt.sock
EOF

cat <<EOF | tee $slave_service $slave_public_service
[Unit]
Description=Diagnostics: DCOS Distributed Diagnostics Tool
[Service]
PermissionsStartOnly=True
EnvironmentFile=/opt/mesosphere/environment
Restart=always
StartLimitInterval=0
RestartSec=5
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-3dt-agent
ExecStart=/opt/mesosphere/bin/3dt -endpoint-config ${PKG_PATH}/endpoints_config.json -agent-port 61002 -force-tls
User=dcos_3dt
EOF

cat <<EOF | tee $master_service
[Unit]
Description=Diagnostics: DCOS Distributed Diagnostics Tool Master API and Aggregation Service
[Service]
PermissionsStartOnly=True
EnvironmentFile=/opt/mesosphere/environment
Restart=always
StartLimitInterval=0
RestartSec=5
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-3dt-master
ExecStart=/opt/mesosphere/bin/3dt -pull -ca-cert /run/dcos/pki/CA/certs/ca.crt -endpoint-config ${PKG_PATH}/endpoints_config.json -master-port 443 -agent-port 61002 -force-tls
User=dcos_3dt
EOF
