#!/bin/bash

mkdir -p "$PKG_PATH/usr/"

cp -rp /pkg/src/marathon/target/scala-2.11/marathon-assembly-*.jar "$PKG_PATH/usr/marathon.jar"

mkdir -p "$PKG_PATH/usr/plugins/lib"
unzip /pkg/src/marathon-plugins/plugins.zip -d "$PKG_PATH/usr/plugins/lib"
cp /pkg/src/marathon-plugin-conf/plugin-conf.json "$PKG_PATH/usr/plugins/plugin-conf.json"

marathon_wrapper="$PKG_PATH/bin/marathon.sh"
mkdir -p "$(dirname "$marathon_wrapper")"
envsubst '$PKG_PATH' < /pkg/extra/marathon.sh > "$marathon_wrapper"
chmod +x "$marathon_wrapper"

sudo chmod -R o+r "$PKG_PATH/usr"

marathon_service="$PKG_PATH/dcos.target.wants_master/dcos-marathon.service"
mkdir -p $(dirname "$marathon_service")

cat <<EOF > "$marathon_service"
[Unit]
Description=Marathon: DC/OS Init System
[Service]
Restart=always
StartLimitInterval=0
RestartSec=15
LimitNOFILE=16384
User=dcos_marathon
PermissionsStartOnly=True
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/marathon
EnvironmentFile=-/opt/mesosphere/etc/marathon-extras
EnvironmentFile=-/run/dcos/etc/marathon/tls.env
EnvironmentFile=-/run/dcos/etc/marathon/zk.env
ExecStartPre=/bin/ping -c1 leader.mesos
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-marathon
ExecStart=/opt/mesosphere/bin/marathon.sh
EOF
