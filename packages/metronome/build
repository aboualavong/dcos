#!/bin/bash
pushd "/pkg/src/metronome"
rm -rf bin/metronome.bat README.md RUNNING_PID share/ logs/
cp -an * "$PKG_PATH/"
cp -f /pkg/extra/logback.xml "$PKG_PATH/conf/"

mkdir -p "$PKG_PATH/usr/plugins/lib"
unzip /pkg/src/metronome-plugins/plugins.zip -d "$PKG_PATH/usr/plugins/lib"
cp /pkg/src/metronome-plugin-conf/plugin-conf.json "$PKG_PATH/usr/plugins/plugin-conf.json"

metronome_service="$PKG_PATH/dcos.target.wants_master/dcos-metronome.service"
mkdir -p $(dirname "$metronome_service")

cat <<EOF > "$metronome_service"
[Unit]
Description=DC/OS Jobs (Metronome): job orchestration

[Service]
User=dcos_metronome
PermissionsStartOnly=True
Restart=always
StartLimitInterval=0
RestartSec=15
LimitNOFILE=16384
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/metronome
EnvironmentFile=-/opt/mesosphere/etc/metronome-extras
EnvironmentFile=-/run/dcos/etc/metronome/service.env
EnvironmentFile=-/run/dcos/etc/metronome/tls.env
ExecStartPre=/bin/ping -c1 leader.mesos
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-metronome
ExecStartPre=/usr/bin/env mkdir -p /run/dcos/etc/metronome
ExecStartPre=/bin/bash -c 'echo "METRONOME_LEADER_ELECTION_HOSTNAME=\$(\$MESOS_IP_DISCOVERY_COMMAND)" > /run/dcos/etc/metronome/service.env'
ExecStartPre=/bin/bash -c 'echo "LIBPROCESS_IP=\$(\$MESOS_IP_DISCOVERY_COMMAND)" >> /run/dcos/etc/metronome/service.env'
ExecStartPre=/usr/bin/env rm -f /run/dcos/etc/metronome/play.pid
ExecStart=/opt/mesosphere/bin/metronome -Dpidfile.path=/run/dcos/etc/metronome/play.pid -Djava.security.properties=/opt/mesosphere/etc/java.security
EOF
