include common/main.conf;


http {
    include common/http.conf;

    client_max_body_size 1024M;

    # Without this, cosocket-based code in worker
    # initialization cannot resolve leader.mesos.
    resolver 127.0.0.1:61053 valid=60s ipv6=off;

    # Name: Mesos DNS
    # Reference: https://docs.mesosphere.com/1.9/networking/mesos-dns/http-interface/
    upstream mesos_dns {
        server 127.0.0.1:8123;
    }

    # Name: Exhibitor (Zookeeper)
    # Reference: https://github.com/soabase/exhibitor/wiki/REST-Introduction
    upstream exhibitor {
        server 127.0.0.1:8181;
    }

    # Name: DC/OS Identity and Access Manager (Bouncer)
    # Reference: https://docs.mesosphere.com/1.9/security/iam-api/
    upstream iam {
        server 127.0.0.1:8101;
    }

    # Name: DC/OS Certificate Authority
    # Reference: https://docs.mesosphere.com/1.9/networking/tls-ssl/ca-api/
    upstream certificate_authority {
        server 127.0.0.1:8888;
    }

    # Name: DC/OS Diagnostics (3DT)
    # Reference: https://docs.mesosphere.com/1.9/monitoring/#system-health-http-api-endpoint
    upstream dddt {
        server unix:/run/dcos/3dt.sock;
    }

    # Name: Vault
    # Reference: https://www.vaultproject.io/api/
    upstream vault_default {
        server 127.0.0.1:8200;
    }

    # Name: Navstar
    upstream navstar {
        server 127.0.0.1:62080;
    }

    # Name: DC/OS Metrics
    # Reference: https://docs.mesosphere.com/1.9/metrics/metrics-api/
    upstream metrics {
        server unix:/run/dcos/dcos-metrics-master.sock;
    }

    lua_shared_dict cache 100m;
    lua_shared_dict shmlocks 100k;
    lua_ssl_trusted_certificate /run/dcos/pki/CA/certs/ca.crt;
    lua_ssl_verify_depth 5;

    init_worker_by_lua '
        cache.periodically_refresh_cache()
    ';

    include /opt/mesosphere/etc/adminrouter-redirect-http-https.conf;

    server {
        server_name master.mesos leader.mesos;
        include common/server.conf;

        include /opt/mesosphere/etc/adminrouter-listen-ee.conf;
        include /opt/mesosphere/etc/adminrouter-upstreams.conf;
        include /opt/mesosphere/etc/adminrouter-tls.conf;

        # Group: Root
        # Description: DC/OS GUI
        root /opt/mesosphere/active/dcos-ui/usr;

        location / {
            # prevent opening in iframe
            add_header X-Frame-Options DENY;
        }

        # ACS integration dev settings.
        #error_log logs/error.log notice;
        #rewrite_log on;
        #lua_code_cache off;

        #---
        # Group: Authentication
        # Description: Access Control Service (unauthenticated)
        location ~ ^/acs/api/v1/auth/(login|logout|jwks|providers|oidc/callback|oidc/providers/?|saml/providers/?)$ {
            # Make the following IAM endpoints be freely accessible:
            # - /auth/login
            # - /auth/logout
            # - /auth/jwks
            # - /auth/providers
            # - /auth/oidc/providers(/)
            # - /auth/saml/providers(/)
            # - /auth/oidc/callback
            include common/proxy-headers.conf;
            proxy_pass http://iam;
        }

        # Group: Authentication
        # Description: Access Control Service SAML provider callback (unauthenticated)
        location ~ ^/acs/api/v1/auth/saml/providers/[0-9a-zA-Z-]+/acs-callback$ {
            include common/proxy-headers.conf;
            # Make the SAML ACS callback URL be freely accessible.
            proxy_pass http://iam;
        }

        # Group: Authentication
        # Description: Access Control List schema
        location = /acs/acl-schema.json {
            access_by_lua_block {
                auth.access_aclschema_endpoint();
            }
            alias /opt/mesosphere/active/acl-schema/etc/acl-schema.json;
        }

        # Group: Authentication
        # Description: Access Control List schema
        location ~ ^/acs/api/v1/users/(?<uid_path>.*)/permissions$ {
            access_by_lua '
                -- Note(JP): Authorize this resource on behalf of the IAM
                -- which does not yet implement an authorizer on its own.
                local object = "dcos:iam:users:" .. ngx.var.uid_path .. ":permissions"
                local action = "read"

                -- Deny access if request is not authenticated.
                local uid = auth.validate_jwt_or_exit(object, action)

                -- Allow request if user requests his/her own permissions
                -- or if requesting user has full access to the IAM.
                if uid ~= ngx.var.uid_path then
                    local triple = {
                        uid = uid,
                        rid = "dcos:adminrouter:acs",
                        action = "full"
                        }
                    auth.check_access_control_entry_or_exit(triple)
                else
                    local auditlogparms = {
                        uid = uid,
                        object = object,
                        action = action,
                        result = "allow",
                        reason = "user requests his/her own permissions"
                        }
                    auth.auditlog(auditlogparms)
                end
            ';
            include common/disable-response_caching.conf;
            include common/proxy-headers.conf;
            proxy_pass http://iam;
        }

        # Group: Authentication
        # Description: Access Control Service policy query (unauthenticated, internal-only)
        location /internal/acs/api/v1/internal/policyquery {
            # This endpoint answers if action <a> is allowed to be performed by
            # user <u> on resource <r>. <r>, <u>, <a> are transmitted via query
            # parameters. This location does not require authentication. It is
            # meant to serve only trusted (remote) ends. For now, keep it
            # only accessible by nginx' subrequests, via the 'internal' directive.
            # http://nginx.org/en/docs/http/ngx_http_core_module.html#internal
            internal;

            # Do not send original request headers upstream, see
            # https://github.com/openresty/lua-nginx-module#ngxlocationcapture
            proxy_pass_request_headers off;

            include common/proxy-headers.conf;

            rewrite ^/internal/(.*) /$1 break;
            proxy_pass http://iam;
        }

        # Group: Authentication
        # Description: Access Control Service
        location /acs/api/v1 {
            access_by_lua_block {
                auth.access_acsapi_endpoint();
            }
            include common/proxy-headers.conf;
            include common/disable-response_caching.conf;
            proxy_pass http://iam;
        }

        # DC/OS root CA certificate (see DCOS-8752).
        #---
        # Group: Certificate Authority
        # Description: Get CA public key Privacy Enhanced Mail file (unauthenticated)
        location = /ca/dcos-ca.crt {
            # Payload is encoded in the OpenSSL PEM format. nginx automatically
            # sends a `Content-Type: application/x-x509-ca-cert` header as of
            # the configuration in `mime.types`.
            alias /run/dcos/pki/CA/certs/ca.crt;
        }

        # Java KeyStore file with DC/OS Java's lib/security/cacerts (Java's
        # default CA cert bundle), plus DC/OS root CA certificate (see DCOS-8752).
        # The JKS file is password-protected with the default password 'changeme'.
        #---
        # Group: Certificate Authority
        # Description: Get CA public key Java Key Store file (unauthenticated)
        location = /ca/cacerts.jks {
            # Make location emit JSK MIME type for all requests.
            types { }
            default_type application/x-java-keystore;
            alias /run/dcos/pki/CA/certs/cacerts.jks;
        }

        # Group: Certificate Authority
        # Description: Certificate and basic signing information
        location = /ca/api/v2/info {
            include common/proxy-headers.conf;
            proxy_set_header Authorization "";
            proxy_pass http://certificate_authority;
        }

        # Group: Certificate Authority
        # Description: List of all certificates issued by CA
        location = /ca/api/v2/certificates {
            access_by_lua_block {
                auth.access_cacertificates_endpoint();
            }
            include common/proxy-headers.conf;
            proxy_set_header Authorization "";
            proxy_pass http://certificate_authority;
        }

        # Group: Certificate Authority
        # Description: Certificate Signing Request (CSR)
        location ~ /ca/api/v2/(newcert|newkey|sign)$ {
            access_by_lua_block {
                auth.access_carw_endpoint();
            }
            include common/proxy-headers.conf;
            proxy_set_header Authorization "";
            proxy_pass http://certificate_authority;
        }

        # Group: Mesos
        # Description: Redirect to add trailing slash
        # Visibility: hidden
        location = /mesos {
            rewrite ^/mesos$ $scheme://$http_host/mesos/ permanent;
        }

        # Group: Mesos
        # Description: Apache Mesos
        location /mesos/ {
            access_by_lua_block {
                auth.access_mesos_endpoint();
            }
            include common/proxy-headers.conf;
            rewrite ^/mesos/(.*) /$1 break;
            proxy_pass $upstream_mesos;
        }

        # Group: Package
        # Description: Package Management
        location /package/ {
            access_by_lua_block {
                auth.access_package_endpoint();
            }
            include common/proxy-headers.conf;
            include common/disable-request-response-buffering.conf;
            include common/http-11.conf;

            proxy_pass $upstream_cosmos;
        }

        # Group: Capabilities
        # Description: List of capabilities supported by DC/OS
        location /capabilities {
            access_by_lua_block {
                auth.access_capabilities_endpoint();
            }
            include common/proxy-headers.conf;
            include common/http-11.conf;

            proxy_pass $upstream_cosmos;
        }

        # Group: Cosmos
        # Description: Start a DC/OS service from a DC/OS package
        location /cosmos/service/ {
            access_by_lua_block {
                auth.access_cosmosservice_endpoint();
            }
            include common/proxy-headers.conf;
            include common/http-11.conf;

            rewrite ^/cosmos/(.*) /$1 break;
            proxy_pass $upstream_cosmos;
        }

        # Group: Exhibitor
        # Description: Redirect to add trailing slash
        # Visibility: hidden
        location = /exhibitor {
            rewrite ^/exhibitor$ $scheme://$http_host/exhibitor/ permanent;
        }

        # Group: Exhibitor
        # Description: Exhibitor cluster status (unauthenticated)
        location = /exhibitor/exhibitor/v1/cluster/status {
            proxy_pass http://exhibitor;
            rewrite ^/exhibitor/(.*) /$1 break;
        }

        # Group: Exhibitor
        # Description: Manage Zookeeper
        location /exhibitor/ {
            access_by_lua_block {
                auth.access_exhibitor_endpoint();
            }
            include common/proxy-headers.conf;

            # Exhibitor's web server may be configured to require basic authentication.
            # Replace original Authorization header: if the environment variable
            # EXHIBITOR_ADMIN_HTTPBASICAUTH_CREDS was provided, use its contents to
            # construct a basic auth header. Set the header value to an empty string
            # otherwise.
            set_by_lua $exhibitor_authorization_header '
                if EXHIBITOR_ADMIN_HTTPBASICAUTH_CREDS ~= nil then
                    return "Basic " .. EXHIBITOR_ADMIN_HTTPBASICAUTH_CREDS
                else
                    return ""
                end
            ';
            proxy_set_header Authorization $exhibitor_authorization_header;

            proxy_pass http://exhibitor/;
            proxy_redirect http://$http_host/ $scheme://$http_host/exhibitor/;
        }

        # Group: Network Metrics
        # Description: Networking-related metrics
        location /networking/api/v1/ {
            access_by_lua_block {
                auth.access_networkingapi_endpoint();
            }
            include common/disable-response_caching.conf;
            include common/proxy-headers.conf;
            rewrite ^/networking/api/v1/(.*) /$1 break;
            proxy_pass $upstream_networking_api;
        }

        # Group: Navstar
        location /navstar/lashup/key {
            access_by_lua_block {
                auth.access_lashupkey_endpoint();
            }

            include common/proxy-headers.conf;
            proxy_pass http://navstar/lashup/key;
        }

        # Group: Agent
        # Description: Redirect to add trailing slash
        # Visibility: hidden
        location ~ ^/(slave|agent)/(?<agentid>[0-9a-zA-Z-]+)$ {
            # Append slash and perform internal redirect.
            rewrite ^/(slave|agent)/(.*)$ /agent/$2/ last;
        }

        # Group: Agent
        # Description: API proxy to a specific agent node
        location ~ ^/(slave|agent)/(?<agentid>[0-9a-zA-Z-]+)(?<url>.+)$ {
            set $agentaddr '';
            set $agentport '';
            rewrite ^/(slave|agent)/[0-9a-zA-Z-]+/.*$ $url break;
            rewrite_by_lua_block {
                auth.access_agent_endpoint();
                agent.resolve();
            }

            more_clear_input_headers Accept-Encoding;
            include common/proxy-headers.conf;
            # Enabling HTTP/1.1 does not matter for non-streaming endpoints as
            # we do not use backend connection pooling anyway.
            include common/http-11.conf;
            # Disabling all buffering here is OK, as Mesos Agent does not care
            # about it for non-streaming API endpoints while at the same time
            # stdin/stdout redirection to/from tasks requires it.
            include common/disable-request-response-buffering.conf;
            proxy_pass $agentaddr:$agentport;
        }

        # Group: Service
        # Description: Redirect to add trailing slash
        # Visibility: hidden
        location ~ ^/service/(?<serviceid>[0-9a-zA-Z-.]+)$ {
            # Append slash and 301-redirect.
            rewrite ^/service/(.*)$ /service/$1/ permanent;
        }

        # Group: Service
        # Description: Proxy to services running on DC/OS
        location ~ ^/service/(?<service_path>.+) {
            set $upstream_url '';
            set $upstream_scheme '';
            set $service_realpath '';

            more_clear_input_headers Accept-Encoding;
            rewrite_by_lua_block {
                -- Auth is done during recursive_resolve stage, here we only
                -- pass the module.
                service.recursive_resolve(auth, ngx.var.service_path);
            }

            include common/proxy-headers.conf;
            include common/websockets.conf;
            include common/disable-request-response-buffering.conf;

            proxy_redirect $upstream_scheme://$host/service/$service_realpath/ /service/$service_realpath/;
            proxy_redirect $upstream_scheme://$host/ /service/$service_realpath/;
            proxy_redirect / /service/$service_realpath/;

            proxy_pass $upstream_url;
        }

        # Group: Metadata
        # Description: Public IP and Cluster ID
        location /metadata {
            access_by_lua_block {
                auth.access_metadata_endpoint();
            }
            content_by_lua_file conf/lib/metadata.lua;
        }

        # Group: Metadata
        # Description: DC/OS GUI configuration (unauthenticated)
        location /dcos-metadata/ui-config.json {
            # Allow non-authed access for the UI.
            alias /opt/mesosphere/etc/ui-config.json;
        }

        # Group: Metadata
        # Description: DC/OS version (unauthenticated)
        location /dcos-metadata/dcos-version.json {
            # Allow non-authed access for the UI.
            alias /opt/mesosphere/active/dcos-metadata/etc/dcos-version.json;
        }

        # Group: Metadata
        # Description: DC/OS bootstrap configuration
        location /dcos-metadata/bootstrap-config.json {
            access_by_lua_block {
                auth.access_metadata_endpoint();
            }
            alias /opt/mesosphere/etc/bootstrap-config.json;
        }

        # Group: Pkgpanda
        # Description: List the active Pkgpanda packages
        location /pkgpanda/active.buildinfo.full.json {
            access_by_lua_block {
                auth.access_metadata_endpoint();
            }
            include common/disable-response_caching.conf;
            alias /opt/mesosphere/active.buildinfo.full.json;
        }

        # Group: History
        location /dcos-history-service/ {
            include common/proxy-headers.conf;
            set $historyservice_upstream '';

            rewrite_by_lua_block {
                auth.access_historyservice_endpoint();
                historyservice.resolve();
            }
            proxy_pass $historyservice_upstream;
        }

        # Group: Mesos DNS
        # Description: Redirect to add trailing slash
        # Visibility: hidden
        location = /mesos_dns {
            rewrite ^/mesos_dns$ $scheme://$http_host/mesos_dns/ permanent;
        }

        # Group: Mesos DNS
        # Description: Domain-based service discovery
        location /mesos_dns/ {
            access_by_lua_block {
                auth.access_mesosdns_endpoint();
            }
            include common/proxy-headers.conf;
            proxy_set_header Authorization "";
            proxy_pass http://mesos_dns/;
        }

        # Group: Mesos DNS
        # Description: Domain-based service discovery (unauthenticated, internal-only)
        location /internal/mesos_dns/ {
            # This location is meant to be used internally in order to resolve
            # MesosDNS SRV records:
            # http://nginx.org/en/docs/http/ngx_http_core_module.html#internal
            internal;

            # Do not send original request headers upstream, see
            # https://github.com/openresty/lua-nginx-module#ngxlocationcapture
            proxy_pass_request_headers off;

            include common/proxy-headers.conf;

            proxy_connect_timeout 2s;
            proxy_read_timeout 3s;
            proxy_pass http://mesos_dns/;
        }

        # Group: Secrets
        # Description: Securely store and retrieve secrets
        location /secrets/v1/ {
            access_by_lua_block {
                auth.access_secrets_endpoint();
            }

            include common/proxy-headers.conf;
            proxy_pass $upstream_secrets;
            proxy_ssl_name 127.0.0.1;
        }

        # Group: Vault
        # Description: Default secrets store
        location /vault/default/ {
            proxy_set_header Authorization "";

            include common/proxy-headers.conf;
            proxy_pass http://vault_default/;
        }

        # Group: Marathon
        # Description: Redirect to add trailing slash
        # Deprecated: Use `/service/marathon/`
        # Visibility: hidden
        location = /marathon {
            rewrite ^/marathon$ /service/marathon/ last;
        }

        # Group: Marathon
        # Deprecated: Use `/service/marathon/`
        location /marathon/ {
            rewrite ^/marathon/(.*)$ /service/marathon/$1 last;
        }

        # Group: System
        # Description: Component service status
        location /system/health/v1 {
            access_by_lua_block {
                auth.access_system_health_endpoint();
            }

            include common/proxy-headers.conf;
            proxy_pass http://dddt;
        }

        # Group: System
        # Description: Node, component service, and container (task) logs
        location /system/v1/logs/v1/ {
            access_by_lua_block {
                auth.access_system_logs_endpoint();
            }

            include common/http-11.conf;
            include common/proxy-headers.conf;
            proxy_pass_header X-Accel-Buffering;
            proxy_pass http://log/;
        }

        # Group: System
        # Description: Node, container, and application metrics
        location /system/v1/metrics/ {
            access_by_lua_block {
                auth.access_system_metrics_endpoint();
            }

            include common/proxy-headers.conf;
            proxy_pass http://metrics/;
        }

        # Group: System
        # Description: System proxy to the master node with the Mesos leader
        location ~ ^/system/v1/leader/mesos(?<url>.*)$ {
            access_by_lua_block {
                auth.access_system_mesosleader_endpoint();
            }

            include common/http-11.conf;
            include common/proxy-headers.conf;
            proxy_pass http://leader.mesos/system/v1$url$is_args$query_string;
        }

        # Group: System
        # Description: System proxy to the master node with the Marathon leader
        location ~ ^/system/v1/leader/marathon(?<url>.*)$ {
            set $mleader_host '';
            rewrite_by_lua_block {
                auth.access_system_marathonleader_endpoint();
                mleader.resolve();
            }

            include common/http-11.conf;
            include common/proxy-headers.conf;
            proxy_pass $mleader_host/system/v1$url$is_args$query_string;
        }

        # Group: System
        # Description: System proxy to a specific agent node
        location ~ ^/system/v1/agent/(?<agentid>[0-9a-zA-Z-]+)(?<type>(/logs/v1|/metrics/v0))(?<url>.*)$ {
            set $agentaddr '';
            rewrite_by_lua_block {
                auth.access_system_agent_endpoint();
                agent.resolve();
            }
            rewrite ^/agent/[0-9a-zA-Z-]+(.*)$ $1 break;

            more_clear_input_headers Accept-Encoding;
            include common/http-11.conf;
            include common/proxy-headers.conf;
            proxy_pass $agentaddr:$adminrouter_agent_port/system/v1$type$url$is_args$query_string;
        }
    }
}
