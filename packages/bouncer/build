#!/bin/bash
source /opt/mesosphere/environment.export
export LIB_INSTALL_DIR="$PKG_PATH/lib/python3.5/site-packages"
mkdir -p "$LIB_INSTALL_DIR"

# This is expected to succeed.
echo "attempt: python -c 'import xmlsec'"
python -c 'import xmlsec'

echo "pip version: $(pip --version)"
echo "Install packages from wheel files."
pip install --no-deps --no-index --target="$LIB_INSTALL_DIR" /pkg/src/jsonschema/*.whl

# Resolve 'Package libffi was not found in the pkg-config search path'.
export PKG_CONFIG_PATH=/opt/mesosphere/lib/pkgconfig

# Install from local source directories (git checkout or extracted tarballs).
# Order matters. Some of these packages require Cython or build C extensions
# for speed-up if Cython is availble.
echo "Install packages from local source directories."
for package in \
    pycparser \
    falcon \
    python-mimeparse \
    oic \
    pycryptodome \
    python3-saml \
    ldap3
do
  pip install --no-deps --install-option="--prefix=$PKG_PATH" --root=/ /pkg/src/$package
done


# TODO(cmaloney): Make bouncer install as a proper python package.
# Install bouncer (only cp directory tree).
# TODO(jp): cherry-pick what is required.
cp -r "/pkg/src/bouncer" "$PKG_PATH/bouncer"


# Deploy service file.
SERVICE_FILE_NAME="dcos-bouncer.service"
SERVICE_FILE_PATH="$PKG_PATH/dcos.target.wants_master/${SERVICE_FILE_NAME}"
mkdir -p "$(dirname "$SERVICE_FILE_PATH")"
envsubst '$PKG_PATH' < "/pkg/extra/${SERVICE_FILE_NAME}" > "${SERVICE_FILE_PATH}"
