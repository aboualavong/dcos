#!/bin/bash

cd /pkg/src/cockroach

# Build the cockroach binary.
make build

# Copy the cockroach binary to the the package bin directory.
mkdir -p $PKG_PATH/bin
install -m 755 src/github.com/cockroachdb/cockroach/cockroach $PKG_PATH/bin

# Copy the wrapper script to the package bin directory.
install -m 755 /pkg/extra/cockroach.py $PKG_PATH/bin/cockroach.py

# Copy the disable_diagnostics.py script to the package bin directory.
install -m 755 /pkg/extra/disable_diagnostics.py $PKG_PATH/bin/disable_diagnostics.py

# Auto-start the dcos-cockroach service on the masters.
mkdir -p "$PKG_PATH/dcos.target.wants_master"
cp /pkg/extra/dcos-cockroach.service "$PKG_PATH/dcos.target.wants_master/dcos-cockroach.service"

# Auto-start the dcos-cockroach-disable-diagnostics-reporting service
# on the masters. This is a service that will become inactive
# once it executes and terminates successfully.
cp /pkg/extra/dcos-cockroach-disable-diagnostics-reporting.service "$PKG_PATH/dcos.target.wants_master/dcos-cockroach-disable-diagnostics-reporting.service"
