#!/bin/bash

set -e

# cockroachdb requires gcc 4.9+
apt-get -y update
apt-get install -y gcc-4.9 g++-4.9 cpp-4.9

update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 40
update-alternatives --install /usr/bin/cpp cpp /usr/bin/cpp-4.9 40
update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.9 40

GOLANG_VERSION=1.9.2
GOLANG_DOWNLOAD_URL=https://golang.org/dl/go$GOLANG_VERSION.linux-amd64.tar.gz
GOLANG_DOWNLOAD_SHA256=de874549d9a8d8d8062be05808509c09a88a248e77ec14eb77453530829ac02b

rm -rf /usr/local/go
curl -fsSL "$GOLANG_DOWNLOAD_URL" -o golang.tar.gz
echo "$GOLANG_DOWNLOAD_SHA256  golang.tar.gz" | sha256sum -c -
tar -C /usr/local -xzf golang.tar.gz
rm golang.tar.gz

cd /pkg/src/cockroach

# Build the cockroach binary.
make build TYPE=portable

# Copy the cockroach binary to the the package bin directory.
mkdir -p $PKG_PATH/bin
install -m 755 src/github.com/cockroachdb/cockroach/cockroach $PKG_PATH/bin

# Copy the registration script to the package bin directory.
install -m 755 /pkg/extra/register.py $PKG_PATH/bin/register.py

# Copy the launch script to the package bin directory.
install -m 755 /pkg/extra/cockroach.sh $PKG_PATH/bin/cockroach.sh

# Copy the disable_diagnostics.py script to the package bin directory.
install -m 755 /pkg/extra/disable_diagnostics.py $PKG_PATH/bin/disable_diagnostics.py

# Auto-start the dcos-cockroach service on the masters.
mkdir -p "$PKG_PATH/dcos.target.wants_master"
cp /pkg/extra/dcos-cockroach.service "$PKG_PATH/dcos.target.wants_master/dcos-cockroach.service"

# Auto-start the dcos-cockroach-disable-diagnostics-reporting service
# on the masters. This is a service that will become inactive
# once it executes and terminates successfully.
cp /pkg/extra/dcos-cockroach-disable-diagnostics-reporting.service "$PKG_PATH/dcos.target.wants_master/dcos-cockroach-disable-diagnostics-reporting.service"
