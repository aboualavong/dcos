#!/bin/bash

# cockroachdb requires gcc 4.9+
apt-get -y update
apt-get install -y gcc-4.9 g++-4.9 cpp-4.9

update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 40
update-alternatives --install /usr/bin/cpp cpp /usr/bin/cpp-4.9 40
update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.9 40

cd /pkg/src/cockroach

# Build the cockroach binary.
make build

# Copy the cockroach binary to the the package bin directory.
mkdir -p $PKG_PATH/bin
install -m 755 src/github.com/cockroachdb/cockroach/cockroach $PKG_PATH/bin

# Copy the registration script to the package bin directory.
install -m 755 /pkg/extra/register.py $PKG_PATH/bin/register.py

# Copy the launch script to the package bin directory.
install -m 755 /pkg/extra/cockroach.sh $PKG_PATH/bin/cockroach.sh

# Copy the disable_diagnostics.py script to the package bin directory.
install -m 755 /pkg/extra/disable_diagnostics.py $PKG_PATH/bin/disable_diagnostics.py

# Auto-start the dcos-cockroach service on the masters.
mkdir -p "$PKG_PATH/dcos.target.wants_master"
cp /pkg/extra/dcos-cockroach.service "$PKG_PATH/dcos.target.wants_master/dcos-cockroach.service"

# Auto-start the dcos-cockroach-disable-diagnostics-reporting service
# on the masters. This is a service that will become inactive
# once it executes and terminates successfully.
cp /pkg/extra/dcos-cockroach-disable-diagnostics-reporting.service "$PKG_PATH/dcos.target.wants_master/dcos-cockroach-disable-diagnostics-reporting.service"
