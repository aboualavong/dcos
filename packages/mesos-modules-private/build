#!/bin/bash
set -o nounset -o pipefail

pushd /pkg/src/mesos-modules-private
./bootstrap
popd

# Add `protoc` to the path.
export PATH=/opt/mesosphere/lib/mesos/3rdparty/bin:$PATH

# Add the 3rdparty directories.
export CPPFLAGS='-I/opt/mesosphere/active/boost-libs/include -I/opt/mesosphere/lib/mesos/3rdparty/include'
export CFLAGS=-I/opt/mesosphere/lib/mesos/3rdparty/include
export LDFLAGS='-L/opt/mesosphere/active/boost-libs/lib -L/opt/mesosphere/lib/mesos/3rdparty/lib'

mkdir -p build
pushd build
/pkg/src/mesos-modules-private/configure \
 --with-mesos=/opt/mesosphere/active/mesos \
 --with-openssl=/opt/mesosphere/active/openssl \
 --with-glog=/opt/mesosphere/lib/mesos/3rdparty/include/glog \
 --prefix="$PKG_PATH"

make -j$NUM_CORES
make install
popd

# Install DC/OS authenticatee module.
mkdir -p "$PKG_PATH/etc/mesos-scheduler-modules"
cp /pkg/extra/dcos_authenticatee_module.json "$PKG_PATH/etc/mesos-scheduler-modules/"
